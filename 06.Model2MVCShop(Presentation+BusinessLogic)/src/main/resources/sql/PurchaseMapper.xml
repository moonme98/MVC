<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="PurchaseMapper">

    <!-- ResultMap -->
    <resultMap id="purchaseMap" type="com.model2.mvc.service.domain.Purchase">
        <id 	property="tranNo"        column="tran_no"         jdbcType="INTEGER"/>
        <result property="paymentOption" column="payment_option"  jdbcType="VARCHAR"/>
        <result property="receiverName"  column="receiver_name"   jdbcType="VARCHAR"/>
        <result property="receiverPhone" column="receiver_phone"  jdbcType="VARCHAR"/>
        <result property="divyAddr"      column="demailaddr"       jdbcType="VARCHAR"/>
        <result property="divyRequest"   column="dlvy_request"    jdbcType="VARCHAR"/>
        <result property="divyDate"      column="dlvy_date"       jdbcType="VARCHAR"/>
        <result property="tranCode"      column="tran_status_code"       jdbcType="VARCHAR"/>
        <result property="orderDate"     column="order_date"      jdbcType="DATE"/>
        
        <association property="buyer" javaType="com.model2.mvc.service.domain.User">
            <id property="userId"    	column="buyer_id" 		jdbcType="VARCHAR"/>
			<result property="userName" column="user_name" 		jdbcType="VARCHAR"/>
			<result property="password" column="password" 		jdbcType="VARCHAR"/>
			<result property="role"		column="role" 			jdbcType="VARCHAR"/>
			<result property="ssn" 		column="ssn" 			jdbcType="VARCHAR"/>
			<result property="phone" 	column="cell_phone" 	jdbcType="VARCHAR"/>
			<result property="addr" 	column="addr" 			jdbcType="VARCHAR"/>
			<result property="email" 	column="email" 			jdbcType="VARCHAR"/>
			<result property="regDate" 	column="user_reg_date" 	jdbcType="DATE"/>
        </association>
        
        <association property="purchaseProd" javaType="com.model2.mvc.service.domain.Product">
            <id property="prodNo" 			column="prod_no" 			jdbcType="NUMERIC"/>
			<result property="prodName" 	column="prod_name" 			jdbcType="VARCHAR"/>
			<result property="prodDetail" 	column="prod_detail" 		jdbcType="VARCHAR"/>
			<result property="manuDate" 	column="manufacture_day" 	jdbcType="VARCHAR"/>
			<result property="price" 		column="price" 				jdbcType="NUMERIC"/>
			<result property="fileName" 	column="image_file" 		jdbcType="VARCHAR"/>
			<result property="regDate" 		column="prod_reg_date" 		jdbcType="DATE"/>
			<result property="proTranCode" column="TRAN_STATUS_CODE" 	jdbcType="VARCHAR"/>
        </association>
    </resultMap>

    <!-- insert -->
<!--     <insert id="addPurchase" parameterType="com.model2.mvc.service.domain.Purchase" useGeneratedKeys="true" keyProperty="tranNo"> -->
    <insert id="addPurchase" parameterType="com.model2.mvc.service.domain.Purchase" >
        <selectKey keyProperty="tranNo" resultType="int" order="BEFORE">
	        SELECT seq_transaction_tran_no.NEXTVAL FROM dual
	    </selectKey>
        INSERT INTO transaction (
            tran_no, buyer_id, payment_option, receiver_name, receiver_phone, demailaddr, dlvy_request, dlvy_date, tran_status_code, prod_no, order_data
        ) VALUES (
        	#{tranNo},
            #{buyer.userId},
            #{paymentOption},
            #{receiverName},
            #{receiverPhone},
            #{divyAddr},
            #{divyRequest},
            #{divyDate},
            #{tranCode},
            #{purchaseProd.prodNo},
            SYSDATE
        )
    </insert>

    <!-- select by tranNo -->
    <select id="getPurchase" parameterType="int" resultMap="purchaseMap">
        SELECT t.*, p.prod_name, p.price
        FROM transaction t
        JOIN product p ON t.prod_no = p.prod_no
        WHERE t.tran_no = #{tranNo}
    </select>

    <!-- update purchase -->
    <update id="updatePurchase" parameterType="com.model2.mvc.service.domain.Purchase">
        UPDATE transaction
        SET buyer_id = #{buyer.userId},
            payment_option = #{paymentOption},
            receiver_name = #{receiverName},
            receiver_phone = #{receiverPhone},
            demailaddr = #{divyAddr},
            dlvy_request = #{divyRequest},
            dlvy_date = #{divyDate}
        WHERE tran_no = #{tranNo}
    </update>

    <!-- update tranCode -->
    <update id="updateTranCode" parameterType="com.model2.mvc.service.domain.Purchase">
        UPDATE transaction
        SET tran_status_code = #{tranCode}
        WHERE tran_no = #{tranNo}
    </update>

    <!-- 구매 리스트 -->
    <select id="getPurchaseList" parameterType="com.model2.mvc.common.Search" resultMap="purchaseMap">
        SELECT *
	    FROM (
	        SELECT inner_table.*, ROWNUM AS row_seq
	        FROM (
	            SELECT tran_no, buyer_id, payment_option, receiver_name, receiver_phone, demailaddr, dlvy_request, dlvy_date, tran_status_code, prod_no, order_data
	            FROM transaction
	            <if test="searchCondition != null and searchKeyword != null and searchKeyword != ''">
	                <where>
	                    <if test="searchCondition == 'buyerId'">
	                        buyer_id = #{searchKeyword}
	                    </if>
	                    <if test="searchCondition == 'prodNo'">
	                        prod_no = #{searchKeyword}
	                    </if>
	                    <if test="searchCondition == 'tranCode'">
	                        tran_status_code = #{searchKeyword}
	                    </if>
	                </where>
	            </if>
	            ORDER BY tran_no DESC
	        ) inner_table
	        WHERE ROWNUM &lt;= #{endRowNum}
	    )
	    WHERE row_seq BETWEEN #{startRowNum} AND #{endRowNum}
    </select>

    <!-- 판매 리스트 -->
    <select id="getSaleList" parameterType="com.model2.mvc.common.Search" resultMap="purchaseMap">
        SELECT *
	    FROM (
	        SELECT inner_table.*, ROWNUM AS row_seq
	        FROM (
	            SELECT t.tran_no, t.buyer_id, t.payment_option, t.receiver_name, t.receiver_phone,
	                   t.demailaddr, t.dlvy_request, t.dlvy_date, t.tran_status_code, t.prod_no, t.order_data,
	                   p.prod_name, p.price
	            FROM transaction t, product p
	            WHERE t.prod_no = p.prod_no
	            <if test="searchCondition != null and searchKeyword != null and searchKeyword != ''">
	                <where>
	                    <if test="searchCondition == 'buyerId'">
	                        t.buyer_id LIKE '%' || #{searchKeyword} || '%'
	                    </if>
	                    <if test="searchCondition == 'prodName'">
	                        p.prod_name LIKE '%' || #{searchKeyword} || '%'
	                    </if>
	                    <if test="searchCondition == 'price'">
	                        p.price LIKE '%' || #{searchKeyword} || '%'
	                    </if>
	                </where>
	            </if>
	            ORDER BY t.prod_no DESC, t.tran_no DESC
	        ) inner_table
	        WHERE ROWNUM &lt;= #{endRowNum}
	    )
	    WHERE row_seq BETWEEN #{startRowNum} AND #{endRowNum}
    </select>

    <!-- totalCount -->
    <select id="getTotalCount" parameterType="com.model2.mvc.common.Search" resultType="int">
        SELECT COUNT(*)
	    FROM (
	        SELECT tran_no, buyer_id, payment_option, receiver_name, receiver_phone, demailaddr, dlvy_request, dlvy_date, tran_status_code, prod_no, order_data
	        FROM transaction
	        <if test="searchCondition != null and searchKeyword != null and searchKeyword != ''">
	            <where>
	                <if test="searchCondition == 'buyerId'">
	                    buyer_id LIKE '%' || #{searchKeyword} || '%'
	                </if>
	                <if test="searchCondition == 'prodNo'">
	                    prod_no LIKE '%' || #{searchKeyword} || '%'
	                </if>
	                <if test="searchCondition == 'tranCode'">
	                    tran_status_code LIKE '%' || #{searchKeyword} || '%'
	                </if>
	            </where>
	        </if>
	    ) countTable
    </select>
</mapper>
